using System.Linq;
using Content.Client.Stylesheets;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Collections;
using Robust.Shared.Configuration;

namespace Content.Client.Options.UI;

[GenerateTypedNameReferences]
public sealed partial class OptionsTabControlRow : Control
{
    [Dependency] private readonly ILocalizationManager _loc = default!;
    [Dependency] private readonly IConfigurationManager _cfg = default!;

    private ValueList<BaseOption> _options;

    public OptionsTabControlRow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        ResetButton.StyleClasses.Add(StyleBase.ButtonOpenRight);
        ApplyButton.OnPressed += ApplyButtonPressed;
        ResetButton.OnPressed += ResetButtonPressed;
        DefaultButton.OnPressed += DefaultButtonPressed;
    }

    public T AddOption<T>(T option) where T : BaseOption
    {
        _options.Add(option);
        return option;
    }

    public OptionCheckboxCVar AddOptionCheckBox(CVarDef<bool> cVar, CheckBox checkBox)
    {
        return AddOption(new OptionCheckboxCVar(this, _cfg, cVar, checkBox));
    }

    public OptionSliderFloatCVar AddOptionPercentSlider(
        CVarDef<float> cVar,
        OptionSlider slider,
        float min = 0,
        float max = 1,
        float scale = 1)
    {
        return AddOption(new OptionSliderFloatCVar(this, _cfg, cVar, slider, min, max, scale, FormatPercent));
    }

    public OptionSliderIntCVar AddOptionSlider(CVarDef<int> cVar, OptionSlider slider, float min, float max)
    {
        return AddOption(new OptionSliderIntCVar(this, _cfg, cVar, slider, min, max, FormatInt));
    }

    public OptionDropDownCVar<T> AddOptionDropDown<T>(
        CVarDef<T> cVar,
        OptionDropDown dropDown,
        IReadOnlyCollection<OptionDropDownCVar<T>.ValueOption> options)
        where T : notnull
    {
        return AddOption(new OptionDropDownCVar<T>(this, _cfg, cVar, dropDown, options));
    }

    public void ValueChanged()
    {
        UpdateButtonState();
    }

    private void UpdateButtonState()
    {
        var anyModified = _options.Any(option => option.IsModified());
        var anyModifiedFromDefault = _options.Any(option => option.IsModifiedFromDefault());

        DefaultButton.Disabled = !anyModifiedFromDefault;
        ApplyButton.Disabled = !anyModified;
        ResetButton.Disabled = !anyModified;
    }

    private void ApplyButtonPressed(BaseButton.ButtonEventArgs obj)
    {
        foreach (var option in _options)
        {
            if (option.IsModified())
                option.SaveValue();
        }

        _cfg.SaveToFile();
        UpdateButtonState();
    }

    private void ResetButtonPressed(BaseButton.ButtonEventArgs obj)
    {
        foreach (var option in _options)
        {
            option.LoadValue();
        }

        UpdateButtonState();
    }

    private void DefaultButtonPressed(BaseButton.ButtonEventArgs obj)
    {
        foreach (var option in _options)
        {
            option.ResetToDefault();
        }

        UpdateButtonState();
    }

    private string FormatPercent(OptionSliderFloatCVar slider, float value)
    {
        return _loc.GetString("ui-options-value-percent", ("value", value));
    }

    private static string FormatInt(OptionSliderIntCVar slider, int value)
    {
        return value.ToString();
    }

    public void Initialize()
    {
        foreach (var option in _options)
        {
            option.LoadValue();
        }

        UpdateButtonState();
    }
}

public abstract class BaseOption(OptionsTabControlRow controller)
{
    protected virtual void ValueChanged()
    {
        controller.ValueChanged();
    }

    public abstract void LoadValue();
    public abstract void SaveValue();

    public abstract void ResetToDefault();

    public abstract bool IsModified();
    public abstract bool IsModifiedFromDefault();
}

public abstract class BaseOptionCVar<TValue> : BaseOption
    where TValue : notnull
{
    public event Action<TValue>? ImmediateValueChanged;

    private readonly IConfigurationManager _cfg;
    private readonly CVarDef<TValue> _cVar;

    protected abstract TValue Value { get; set; }

    protected BaseOptionCVar(
        OptionsTabControlRow controller,
        IConfigurationManager cfg,
        CVarDef<TValue> cVar)
        : base(controller)
    {
        _cfg = cfg;
        _cVar = cVar;
    }

    public override void LoadValue()
    {
        Value = _cfg.GetCVar(_cVar);
    }

    public override void SaveValue()
    {
        _cfg.SetCVar(_cVar, Value);
    }

    public override void ResetToDefault()
    {
        Value = _cVar.DefaultValue;
    }

    public override bool IsModified()
    {
        return !IsValueEqual(Value, _cfg.GetCVar(_cVar));
    }

    public override bool IsModifiedFromDefault()
    {
        return !IsValueEqual(Value, _cVar.DefaultValue);
    }

    protected virtual bool IsValueEqual(TValue a, TValue b)
    {
        return EqualityComparer<TValue>.Default.Equals(a, b);
    }

    protected override void ValueChanged()
    {
        base.ValueChanged();

        ImmediateValueChanged?.Invoke(Value);
    }
}

public sealed class OptionCheckboxCVar : BaseOptionCVar<bool>
{
    private readonly CheckBox _checkBox;

    protected override bool Value
    {
        get => _checkBox.Pressed;
        set => _checkBox.Pressed = value;
    }

    public OptionCheckboxCVar(
        OptionsTabControlRow controller,
        IConfigurationManager cfg,
        CVarDef<bool> cVar,
        CheckBox checkBox)
        : base(controller, cfg, cVar)
    {
        _checkBox = checkBox;
        checkBox.OnToggled += _ =>
        {
            ValueChanged();
        };
    }
}

public sealed class OptionSliderFloatCVar : BaseOptionCVar<float>
{
    public float Scale { get; }

    private readonly CVarDef<float> _cVar;
    private readonly OptionSlider _slider;
    private readonly Func<OptionSliderFloatCVar, float, string> _format;

    protected override float Value
    {
        get => _slider.Slider.Value * Scale;
        set
        {
            _slider.Slider.Value = value / Scale;
            UpdateLabelValue();
        }
    }

    public OptionSliderFloatCVar(
        OptionsTabControlRow controller,
        IConfigurationManager cfg,
        CVarDef<float> cVar,
        OptionSlider slider,
        float minValue,
        float maxValue,
        float scale,
        Func<OptionSliderFloatCVar, float, string> format) : base(controller, cfg, cVar)
    {
        Scale = scale;
        _cVar = cVar;
        _slider = slider;
        _format = format;

        slider.Slider.MinValue = minValue;
        slider.Slider.MaxValue = maxValue;

        slider.Slider.OnValueChanged += _ =>
        {
            ValueChanged();
            UpdateLabelValue();
        };
    }

    private void UpdateLabelValue()
    {
        _slider.ValueLabel.Text = _format(this, _slider.Slider.Value);
    }
}

public sealed class OptionSliderIntCVar : BaseOptionCVar<int>
{
    private readonly CVarDef<int> _cVar;
    private readonly OptionSlider _slider;
    private readonly Func<OptionSliderIntCVar, int, string> _format;

    protected override int Value
    {
        get => (int) _slider.Slider.Value;
        set
        {
            _slider.Slider.Value = value;
            UpdateLabelValue();
        }
    }

    public OptionSliderIntCVar(
        OptionsTabControlRow controller,
        IConfigurationManager cfg,
        CVarDef<int> cVar,
        OptionSlider slider,
        float minValue,
        float maxValue,
        Func<OptionSliderIntCVar, int, string> format) : base(controller, cfg, cVar)
    {
        _cVar = cVar;
        _slider = slider;
        _format = format;

        slider.Slider.MinValue = minValue;
        slider.Slider.MaxValue = maxValue;

        slider.Slider.OnValueChanged += _ =>
        {
            ValueChanged();
            UpdateLabelValue();
        };
    }

    private void UpdateLabelValue()
    {
        _slider.ValueLabel.Text = _format(this, (int) _slider.Slider.Value);
    }
}

public sealed class OptionDropDownCVar<T> : BaseOptionCVar<T> where T : notnull
{
    private readonly CVarDef<T> _cVar;
    private readonly OptionDropDown _dropDown;
    private readonly ItemEntry[] _entries;

    protected override T Value
    {
        get => (T)_dropDown.Button.SelectedMetadata!;
        set => _dropDown.Button.SelectId(FindValueId(value));
    }

    public OptionDropDownCVar(
        OptionsTabControlRow controller,
        IConfigurationManager cfg,
        CVarDef<T> cVar,
        OptionDropDown dropDown,
        IReadOnlyCollection<ValueOption> options) : base(controller, cfg, cVar)
    {
        if (options.Count == 0)
            throw new ArgumentException("Need at least one option!");

        _cVar = cVar;
        _dropDown = dropDown;
        _entries = new ItemEntry[options.Count];

        var button = dropDown.Button;
        var i = 0;
        foreach (var option in options)
        {
            _entries[i] = new ItemEntry
            {
                Key = option.Key,
            };

            button.AddItem(option.Label, i);
            button.SetItemMetadata(button.GetIdx(i), option.Key);
            i += 1;
        }

        dropDown.Button.OnItemSelected += args =>
        {
            dropDown.Button.SelectId(args.Id);
            ValueChanged();
        };
    }

    private int FindValueId(T value)
    {
        for (var i = 0; i < _entries.Length; i++)
        {
            if (IsValueEqual(_entries[i].Key, value))
                return i;
        }

        // This will just default select the first entry or whatever.
        return 0;
    }

    public sealed class ValueOption(T key, string label)
    {
        public readonly T Key = key;
        public readonly string Label = label;
    }

    private struct ItemEntry
    {
        public T Key;
    }
}
